# NeTAlD (Network Traffic Anomalies Detection)

Простое, демонстративное решения для поиска аномалий в сетевом трафике. 
**Не используйте это для решения реальных задач.**

A simple, demonstrative solution for finding anomalies in network traffic. 
**This is not suitable for solving real problems of detecting anomalies in network traffic.**

## Запуск модуля
1. Произвести установку дистрибутива Ubuntu 20.04 x64 в минимальной конфигурации.

2. Выполнить вход в систему.

3. Запустить терминал комбинацией клавиш `Ctrl + Alt + T`.

4. Повысить привилегии до уровня root, используя команду `sudo su` в терминале, с последующим вводом пароля.

5. Обновить список пакетов командами `apt update` и `apt upgrade`.

6. Загрузить директорию с проектом "NeTAlD" на сервер и перейти в папку на уровень ниже, выполнив `cd ..`.

7. Установить менеджер пакетов "pip" для python 3, используя команду `apt install python3-pip`.

8. Установить пакет для создания виртуальной среды, командой `apt-get install python3-venv`.

9. Создать виртуальную среду командой `python3 -m venv ALD` и перейти в директорию с проектом, команда `cd NeTAlD`.

10. Активировать виртуальную среду командой `source bin/activate`.

11. Выполнить установку	необходимых библиотек python, командой `pip3 install -r requirements.txt`.

12. Выбрать сетевой интерфейс, на который поступает трафик из контролируемой зоны (посмотреть список интерфейсов можно командой `ip link show`).

13. Запустить программу командой `python3 ald_runner.py --input <имя сетевого интерфейса>`.

14. После этого обнаруженные аномальные потоки будут записываться в базе данных sqlite, относительный путь `db\ald_anomalies.db`.

## Описание модуля
Предлагаемое решение сочетает в себе простоту механизма правил и точность подходов, основанных на машинном обучении, за счет их совместного использования для детектирования аномальной активности в трафике локальной сети. При этом стандартная модель и правил для выявления аномалий не являются универсальными, и **должны быть изменены в соответствии с активностью в контролируемой зоне.**

Сегменты локальных сетей могут значительно отличаться друг от друга в зависимости от: размера, состава сетевого оборудования и конечных узлов, используемых протоколов, типов активностей и других факторов. В соответствии с этим, значения их эталонных метрик могут значительно отличаться. Использование универсальных механизмов выявления аномалий в таких условия, вероятнее всего приведет к одному из двух результатов: большой процент ошибок или низкий процент точных срабатываний.



![Структурная схема модуля.](/img/Ald_struct_sheme.png "Структурная схема модуля")

*Структурная схема модуля*

### Захват трафика

Модуль принимает на вход имя сетевого интерфейса или путь до файла дампа трафика в формате ".pcap". Далее поступающие фреймы раскладываются по потокам. Захват трафика и разделение на потоки обеспечены функционалом библиотеки "nfstraem". Основной функционал модуля реализован в качестве плагина функции "NFStreamer" указанной библиотеки. Дополнительные функции обработки фреймов применяются в момент их получения, а функция обработки потока, по его завершению.

### Обработка фреймов

Особым образом обрабатываются только фреймы, содержащие в себе TCP заголовок c установленными флагами SYN или SYN-ACK (первый и второй фреймы TCP сессии). Для этих фреймов формируется TCP-отпечаток, который содержит в себе значение некоторых полей TCP-заголовка и, сформированный на основании их значений, вектор дополнений. В дальнейшем этот отпечаток используется для определения операционной системы (ОС) источника фрейма. Таким образом, стандартный класс потока nfstream дополняется полученными отпечатками и кандидатами ОС взаимодействующих узлов. Физические адреса (MAC-адреса) взаимодействующих устройств используется для определения их вендора. Сетевые адреса (IP-адреса) используются для определения области распространения потока, если оба адреса из пула приватных, то поток считается внутренним ("Internal"), иначе поток определяется как внешний ("External"). Все дополнительные характеристики учитываются далее, при формировании рейтинга аномальности потока по правилам.

## Обработка и классификация потоков

Фактически, эта функция отвечает за классификацию потоков на нормальные и аномальные. Для каждого потоков вычисляются следующие характеристики:
- ***минимальный*** размер фрейма, отправленного от сервера к клиенту;
- ***стандартное отклонение*** выборки размеров фреймов, отправленных от сервера к клиенту;
- ***максимальное*** время получения между двумя фреймами в потоке;
- ***минимальное*** время получения между двумя фреймами в потоке;
- ***максимальный*** размер фрейма, отправленного от клиента к серверу;
- ***количество*** пакетов, отправленных от сервера к клиенту;
- ***длительность*** потока.

Все временные характеристики вычисляются в миллисекундах.
Полученные данные используются для вычисления вероятности отнесения потока к классу аномальных. Далее, исходя из четко заданных правил, для каждого потока формируется рейтинг аномальности. Итоговое решение принимается консолидировано, исходя из вероятности, полученной от модели машинного обучения (МО) и рейтинга аномальности сформированного по правилам.

Если поток был признан аномальным, в базе данных SQLite создается запись, которая содержит:
- IP-адрес источника;
- MAC-адрес источника;
- IP-адрес приемника;
- MAC-адрес приемника;
- время получения первого фрейма потока;
- рейтинг аномальности, сформированный по правилам;
- вероятность отнесения потока к классу аномальных от модели МО.

![Алгоритм работы модуля](/img/Ald_algorithm_sheme.png "Алгоритм работы модуля")

*Алгоритм работы модуля*
